<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBIR Visual Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap">
</head>
<body>
    <!-- Left Sidebar Navigation -->
    <aside class="left-sidebar" id="left-sidebar">
        <div class="sidebar-header">
            <img src="Power-BI.png" alt="Power BI" class="sidebar-logo">
            <span class="sidebar-title">PBIR</span>
            <button class="sidebar-collapse-btn" id="sidebar-collapse-btn" title="Collapse sidebar">
                <span class="collapse-icon"><span class="material-icons-outlined">chevron_left</span></span>
            </button>
        </div>

        <nav class="sidebar-nav">
            <button class="sidebar-nav-btn active" data-tab="filter-visibility" title="Filter Visibility">
                <span class="nav-icon"><span class="material-icons-outlined">visibility</span></span>
                <span class="nav-label">Filter Visibility</span>
            </button>
            <button class="sidebar-nav-btn" data-tab="layer-order" title="Layer Order">
                <span class="nav-icon"><span class="material-icons-outlined">layers</span></span>
                <span class="nav-label">Layer Order</span>
            </button>
            <button class="sidebar-nav-btn" data-tab="visual-interactions" title="Visual Interactions">
                <span class="nav-icon"><span class="material-icons-outlined">hub</span></span>
                <span class="nav-label">Visual Interactions</span>
            </button>
            <button class="sidebar-nav-btn" data-tab="batch-processing" title="Batch Processing">
                <span class="nav-icon"><span class="material-icons-outlined">bolt</span></span>
                <span class="nav-label">Batch Processing</span>
            </button>
        </nav>

        <div class="sidebar-divider"></div>

        <div class="sidebar-quick-actions" id="sidebar-quick-actions">
            <div class="quick-actions-header">
                <span class="quick-actions-title">Quick Actions</span>
            </div>
            <div class="quick-actions-list" id="quick-actions-list">
                <!-- Populated dynamically based on active tab -->
            </div>
        </div>

        <div class="sidebar-divider"></div>

        <!-- Report Structure Tree (shown when folder is loaded) -->
        <div class="sidebar-report-tree hidden" id="sidebar-report-tree">
            <div class="report-tree-header">
                <span class="tree-title">Report Structure</span>
            </div>
            <div class="report-tree-content" id="report-tree-content">
                <!-- Populated when folder is loaded -->
            </div>
        </div>

        <div class="sidebar-footer">
        </div>
    </aside>

    <div class="main-layout">
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <button class="mobile-menu-btn" id="mobile-menu-btn" title="Open menu">
                    <span class="material-icons-outlined">menu</span>
                </button>
                <h1 class="header-title">PBIR Visual Manager</h1>
            </div>
            <div class="header-center">
                <p class="subtitle">Manage visual properties in Power BI PBIR reports</p>
            </div>
            <div class="header-right">
                <button id="manual-btn" class="manual-btn" title="Documentation">
                    <span class="material-icons-outlined">menu_book</span>
                </button>
            </div>
        </header>

        <div id="browser-warning" class="warning hidden">
            This application requires Chrome, Edge, or Opera browser with File System Access API support.
        </div>

        <section class="folder-section">
            <button id="select-folder-btn" class="btn btn-primary">Select Folder</button>
            <button id="refresh-btn" class="btn btn-secondary hidden" title="Reload data from folder"><span class="material-icons-outlined" style="font-size:16px">refresh</span> Refresh</button>
            <span id="folder-path" class="folder-path">No folder selected</span>
            <p class="folder-help">Select the root folder of your PBIR report (the folder containing 'pages' or 'definition' subdirectories)</p>
        </section>

        <!-- Welcome Dashboard (shown when no folder is selected) -->
        <section id="welcome-dashboard" class="welcome-dashboard">
            <div class="welcome-hero">
                <h2 class="welcome-title">Welcome to PBIR Visual Manager</h2>
                <p class="welcome-subtitle">Your toolkit for managing visual properties in Power BI PBIR reports</p>
            </div>

            <div class="feature-cards">
                <div class="feature-card" data-feature="filter-visibility">
                    <div class="feature-icon"><span class="material-icons-outlined">visibility</span></div>
                    <h3 class="feature-title">Filter Visibility</h3>
                    <p class="feature-description">Control which filters viewers can see in your reports. Hide sensitive filters while keeping them active.</p>
                </div>

                <div class="feature-card" data-feature="layer-order">
                    <div class="feature-icon"><span class="material-icons-outlined">layers</span></div>
                    <h3 class="feature-title">Layer Order</h3>
                    <p class="feature-description">Manage visual stacking behavior during interactions. Keep visuals in their defined z-order.</p>
                </div>

                <div class="feature-card" data-feature="visual-interactions">
                    <div class="feature-icon"><span class="material-icons-outlined">hub</span></div>
                    <h3 class="feature-title">Visual Interactions</h3>
                    <p class="feature-description">Define how visuals filter and highlight each other. Create precise cross-filtering experiences.</p>
                </div>

                <div class="feature-card" data-feature="batch-processing">
                    <div class="feature-icon"><span class="material-icons-outlined">bolt</span></div>
                    <h3 class="feature-title">Batch Processing</h3>
                    <p class="feature-description">Apply settings across multiple reports at once. Save time with bulk operations.</p>
                </div>
            </div>

            <div class="welcome-cta">
                <p class="cta-text">Get started by selecting your PBIR report folder</p>
                <button class="btn btn-primary btn-large cta-button" id="welcome-select-folder">
                    <span class="btn-icon"><span class="material-icons-outlined">folder_open</span></span> Select Report Folder
                </button>
            </div>

            <div class="welcome-requirements">
                <details>
                    <summary>Requirements</summary>
                    <ul>
                        <li>Power BI report saved in <strong>PBIR format</strong> (.pbip file)</li>
                        <li>Chrome, Edge, or Opera browser</li>
                        <li>File System Access API support</li>
                    </ul>
                </details>
            </div>
        </section>

        <!-- Tab Navigation (hidden - tabs moved to sidebar) -->
        <div id="tab-navigation" class="tab-navigation hidden">
            <button class="tab-btn active" data-tab="filter-visibility">Filter Visibility</button>
            <button class="tab-btn" data-tab="layer-order">Layer Order</button>
            <button class="tab-btn" data-tab="visual-interactions">Visual Interactions</button>
            <button class="tab-btn" data-tab="batch-processing">Batch Processing</button>
        </div>

        <!-- Filter Visibility Tab -->
        <div id="tab-filter-visibility" class="tab-content active">
            <section id="filter-summary-section" class="summary-section hidden">
                <div class="summary-item">
                    <span class="summary-value" id="total-visuals">0</span>
                    <span class="summary-label">Visuals</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="total-filters">0</span>
                    <span class="summary-label">Filters</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="hidden-filters">0</span>
                    <span class="summary-label">Hidden</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="visible-filters">0</span>
                    <span class="summary-label">Visible</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="default-filters">0</span>
                    <span class="summary-label">Default</span>
                </div>
            </section>

            <!-- Status Legend for Filter Visibility -->
            <section id="filter-legend-section" class="legend-section hidden">
                <details class="legend-details">
                    <summary>Status Legend</summary>
                    <div class="legend-grid">
                        <span class="status-badge status-hidden">Hidden</span><span>Filter hidden from viewers</span>
                        <span class="status-badge status-visible">Visible</span><span>Filter visible to viewers</span>
                        <span class="status-badge status-default">Default</span><span>Using Power BI default</span>
                        <span class="status-badge status-mixed">Mixed</span><span>Filters have different settings</span>
                    </div>
                </details>
            </section>

            <!-- Visual Naming Alert for Filter Tab -->
            <section id="filter-naming-alert" class="naming-alert-section hidden">
                <div class="alert-warning">
                    <span class="alert-icon"><span class="material-icons-outlined">warning</span></span>
                    <div class="alert-content">
                        <strong><span id="filter-unnamed-count">0</span> visuals have no title</strong>
                        <p>Consider adding titles in Power BI Desktop for easier identification.</p>
                        <details>
                            <summary>Show unnamed visuals</summary>
                            <ul id="filter-unnamed-list" class="unnamed-list"></ul>
                        </details>
                    </div>
                </div>
            </section>

            <!-- Filter Presets Section -->
            <section id="filter-presets-section" class="presets-section hidden">
                <div class="presets-header">
                    <span class="presets-title">Quick Actions</span>
                </div>
                <div class="presets-grid">
                    <button class="preset-btn" data-preset="hide-all-filters" title="Set all filters to hidden">
                        <span class="preset-icon"><span class="material-icons-outlined">visibility_off</span></span> Hide All
                    </button>
                    <button class="preset-btn" data-preset="show-all-filters" title="Set all filters to visible">
                        <span class="preset-icon"><span class="material-icons-outlined">visibility</span></span> Show All
                    </button>
                    <button class="preset-btn" data-preset="reset-all-filters" title="Remove property from all filters">
                        <span class="preset-icon"><span class="material-icons-outlined">restart_alt</span></span> Reset All
                    </button>
                </div>
                <div class="custom-presets-container">
                    <div id="filter-custom-presets" class="custom-presets-grid"></div>
                    <button id="filter-save-preset-btn" class="btn btn-secondary btn-sm" title="Save current selection as a preset">
                        + Save Preset
                    </button>
                </div>
            </section>

            <section id="filter-actions-section" class="actions-section hidden">
                <div class="actions-row">
                    <div class="selection-actions">
                        <button id="filter-select-all-btn" class="btn btn-secondary">Select All</button>
                        <button id="filter-select-none-btn" class="btn btn-secondary">Select None</button>
                    </div>
                    <div class="bulk-actions">
                        <button id="set-true-btn" class="btn btn-action" disabled title="Hide filters from report viewers (select visuals first)">Set Hidden (true)</button>
                        <button id="set-false-btn" class="btn btn-action" disabled title="Show filters to report viewers (select visuals first)">Set Visible (false)</button>
                        <button id="filter-remove-prop-btn" class="btn btn-action" disabled title="Remove the property and use Power BI default (select visuals first)">Remove Property</button>
                    </div>
                    <p class="action-hint" id="filter-action-hint">Select one or more visuals to enable actions</p>
                    <div class="filter-actions">
                        <label for="filter-status-filter">Filter by status:</label>
                        <select id="filter-status-filter">
                            <option value="all">All</option>
                            <option value="hidden">Hidden (true)</option>
                            <option value="visible">Visible (false)</option>
                            <option value="default">Default (not set)</option>
                            <option value="mixed">Mixed</option>
                            <option value="no-filters">No Filters</option>
                        </select>
                    </div>
                </div>
            </section>

            <section id="filter-table-section" class="table-section hidden">
                <table class="visuals-table">
                    <thead>
                        <tr>
                            <th class="col-checkbox"><input type="checkbox" id="filter-header-checkbox"></th>
                            <th class="col-expand"></th>
                            <th class="col-page">Page</th>
                            <th class="col-visual">Visual</th>
                            <th class="col-type">Type</th>
                            <th class="col-filters">Filters</th>
                            <th class="col-status">Status</th>
                        </tr>
                    </thead>
                    <tbody id="filter-visuals-tbody">
                    </tbody>
                </table>
            </section>

            <section id="filter-save-section" class="save-section hidden">
                <div class="save-row">
                    <button id="filter-save-btn" class="btn btn-primary" disabled>Save Changes</button>
                    <span id="filter-modified-status" class="modified-status">No changes</span>
                </div>
            </section>

            <section id="filter-history-section" class="history-section hidden">
                <div class="history-row">
                    <button id="filter-undo-btn" class="btn btn-secondary" disabled>Undo</button>
                    <button id="filter-undo-all-btn" class="btn btn-secondary" disabled>Undo All</button>
                    <button id="filter-export-csv-btn" class="btn btn-secondary">Export CSV</button>
                    <button id="filter-export-json-btn" class="btn btn-secondary">Export JSON</button>
                    <span id="filter-history-status" class="history-status">History: 0 changes</span>
                </div>
            </section>
        </div>

        <!-- Layer Order Tab -->
        <div id="tab-layer-order" class="tab-content hidden">
            <section id="layer-summary-section" class="summary-section hidden">
                <div class="summary-item">
                    <span class="summary-value" id="layer-total-visuals">0</span>
                    <span class="summary-label">Visuals</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="layer-enabled">0</span>
                    <span class="summary-label">Enabled</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="layer-disabled">0</span>
                    <span class="summary-label">Disabled</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="layer-not-set">0</span>
                    <span class="summary-label">Not Set</span>
                </div>
            </section>

            <!-- Status Legend for Layer Order -->
            <section id="layer-legend-section" class="legend-section hidden">
                <details class="legend-details">
                    <summary>Status Legend</summary>
                    <div class="legend-grid">
                        <span class="status-badge status-visible">Enabled</span><span>Visual stays in its layer position</span>
                        <span class="status-badge status-hidden">Disabled</span><span>Visual may move to front on click</span>
                        <span class="status-badge status-default">Not Set</span><span>Using Power BI default behavior</span>
                    </div>
                </details>
            </section>

            <!-- Visual Naming Alert for Layer Tab -->
            <section id="layer-naming-alert" class="naming-alert-section hidden">
                <div class="alert-warning">
                    <span class="alert-icon"><span class="material-icons-outlined">warning</span></span>
                    <div class="alert-content">
                        <strong><span id="layer-unnamed-count">0</span> visuals have no title</strong>
                        <p>Consider adding titles in Power BI Desktop for easier identification.</p>
                        <details>
                            <summary>Show unnamed visuals</summary>
                            <ul id="layer-unnamed-list" class="unnamed-list"></ul>
                        </details>
                    </div>
                </div>
            </section>

            <!-- Layer Order Presets Section -->
            <section id="layer-presets-section" class="presets-section hidden">
                <div class="presets-header">
                    <span class="presets-title">Quick Actions</span>
                </div>
                <div class="presets-grid">
                    <button class="preset-btn" data-preset="lock-all-layers" title="Enable keepLayerOrder for all visuals">
                        <span class="preset-icon"><span class="material-icons-outlined">lock</span></span> Lock All
                    </button>
                    <button class="preset-btn" data-preset="unlock-all-layers" title="Disable keepLayerOrder for all visuals">
                        <span class="preset-icon"><span class="material-icons-outlined">lock_open</span></span> Unlock All
                    </button>
                    <button class="preset-btn" data-preset="reset-all-layers" title="Remove keepLayerOrder property from all visuals">
                        <span class="preset-icon"><span class="material-icons-outlined">restart_alt</span></span> Reset All
                    </button>
                </div>
                <div class="custom-presets-container">
                    <div id="layer-custom-presets" class="custom-presets-grid"></div>
                    <button id="layer-save-preset-btn" class="btn btn-secondary btn-sm" title="Save current selection as a preset">
                        + Save Preset
                    </button>
                </div>
            </section>

            <section id="layer-actions-section" class="actions-section hidden">
                <div class="actions-row">
                    <div class="selection-actions">
                        <button id="layer-select-all-btn" class="btn btn-secondary">Select All</button>
                        <button id="layer-select-none-btn" class="btn btn-secondary">Select None</button>
                    </div>
                    <div class="bulk-actions">
                        <button id="layer-set-true-btn" class="btn btn-action" disabled title="Keep visuals in their defined layer order (select visuals first)">Set Enabled (true)</button>
                        <button id="layer-set-false-btn" class="btn btn-action" disabled title="Allow visuals to move to front on interaction (select visuals first)">Set Disabled (false)</button>
                        <button id="layer-remove-prop-btn" class="btn btn-action" disabled title="Remove the property and use Power BI default (select visuals first)">Remove Property</button>
                    </div>
                    <p class="action-hint" id="layer-action-hint">Select one or more visuals to enable actions</p>
                    <div class="filter-actions">
                        <label for="layer-status-filter">Filter by status:</label>
                        <select id="layer-status-filter">
                            <option value="all">All</option>
                            <option value="enabled">Enabled (true)</option>
                            <option value="disabled">Disabled (false)</option>
                            <option value="not-set">Not Set</option>
                        </select>
                    </div>
                </div>
            </section>

            <section id="layer-table-section" class="table-section hidden">
                <table class="visuals-table layer-table">
                    <thead>
                        <tr>
                            <th class="col-checkbox"><input type="checkbox" id="layer-header-checkbox"></th>
                            <th class="col-page">Page</th>
                            <th class="col-visual">Visual</th>
                            <th class="col-type">Type</th>
                            <th class="col-status" title="keepLayerOrder property - controls visual stacking behavior">Layer Behavior</th>
                        </tr>
                    </thead>
                    <tbody id="layer-visuals-tbody">
                    </tbody>
                </table>
            </section>

            <section id="layer-save-section" class="save-section hidden">
                <div class="save-row">
                    <button id="layer-save-btn" class="btn btn-primary" disabled>Save Changes</button>
                    <span id="layer-modified-status" class="modified-status">No changes</span>
                </div>
            </section>

            <section id="layer-history-section" class="history-section hidden">
                <div class="history-row">
                    <button id="layer-undo-btn" class="btn btn-secondary" disabled>Undo</button>
                    <button id="layer-undo-all-btn" class="btn btn-secondary" disabled>Undo All</button>
                    <button id="layer-export-csv-btn" class="btn btn-secondary">Export CSV</button>
                    <button id="layer-export-json-btn" class="btn btn-secondary">Export JSON</button>
                    <span id="layer-history-status" class="history-status">History: 0 changes</span>
                </div>
            </section>
        </div>

        <!-- Visual Interactions Tab -->
        <div id="tab-visual-interactions" class="tab-content hidden">
            <!-- Page Selector -->
            <section id="interactions-page-section" class="page-selector-section hidden">
                <div class="page-selector-row">
                    <label for="interactions-page-select">Select Page:</label>
                    <select id="interactions-page-select"></select>
                </div>
            </section>

            <!-- Summary Section -->
            <section id="interactions-summary-section" class="summary-section hidden">
                <div class="summary-item">
                    <span class="summary-value" id="interactions-total">0</span>
                    <span class="summary-label">Possible</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="interactions-explicit">0</span>
                    <span class="summary-label">Overrides</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="interactions-default">0</span>
                    <span class="summary-label">Default</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="interactions-nofilter">0</span>
                    <span class="summary-label">None</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="interactions-datafilter">0</span>
                    <span class="summary-label">Filter</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value" id="interactions-highlightfilter">0</span>
                    <span class="summary-label">Highlight</span>
                </div>
                <div class="summary-item summary-info">
                    <span id="interactions-report-default" class="report-default-info hidden"></span>
                </div>
            </section>

            <!-- Visual Naming Alert -->
            <section id="interactions-naming-alert" class="naming-alert-section hidden">
                <div class="alert-warning">
                    <span class="alert-icon"><span class="material-icons-outlined">warning</span></span>
                    <div class="alert-content">
                        <strong><span id="interactions-unnamed-count">0</span> visuals have no name</strong>
                        <p>Consider adding titles in Power BI Desktop for easier identification.</p>
                        <details>
                            <summary>Show unnamed visuals</summary>
                            <ul id="interactions-unnamed-list" class="unnamed-list"></ul>
                        </details>
                    </div>
                </div>
            </section>

            <!-- Status Legend -->
            <section id="interactions-legend-section" class="legend-section hidden">
                <details class="legend-details">
                    <summary>Interaction Types</summary>
                    <div class="legend-grid interactions-legend">
                        <span class="interaction-badge interaction-default"><span class="material-icons-outlined">radio_button_unchecked</span> Default</span><span>Power BI determines behavior</span>
                        <span class="interaction-badge interaction-filter"><span class="material-icons-outlined">filter_alt</span> Filter</span><span>Selection filters target visual</span>
                        <span class="interaction-badge interaction-highlight"><span class="material-icons-outlined">highlight</span> Highlight</span><span>Selection highlights in target</span>
                        <span class="interaction-badge interaction-none"><span class="material-icons-outlined">block</span> None</span><span>Selection is ignored</span>
                    </div>
                    <div class="legend-note">
                        <strong>Note:</strong> "Default" means Power BI determines the behavior.
                        <span id="interactions-report-default-note" class="hidden">
                            This report's default is <strong id="interactions-report-default-type"></strong>.
                        </span>
                    </div>
                </details>
            </section>

            <!-- Quick Actions -->
            <section id="interactions-presets-section" class="presets-section hidden">
                <div class="presets-header">
                    <span class="presets-title">Quick Actions</span>
                </div>
                <p class="help-text" style="font-size: 0.875rem; color: #666; margin-bottom: 0.75rem;">Apply interaction presets to all visual pairs</p>
                <div class="presets-grid">
                    <button class="preset-btn" data-preset="disable-all-interactions" title="No cross-filtering or highlighting between visuals">
                        <span class="preset-icon"><span class="material-icons-outlined">block</span></span> Disable All
                    </button>
                    <button class="preset-btn" data-preset="enable-all-interactions" title="Removes explicit settings. Behavior determined by report-level defaults">
                        <span class="preset-icon"><span class="material-icons-outlined">radio_button_unchecked</span></span> Reset to Defaults
                    </button>
                    <button class="preset-btn" data-preset="filter-all-interactions" title="Force all interactions to filter (with smart fallbacks for restricted visuals)">
                        <span class="preset-icon"><span class="material-icons-outlined">filter_alt</span></span> Force All to Filter
                    </button>
                    <button class="preset-btn" data-preset="highlight-all-interactions" title="Force all interactions to highlight (with smart fallbacks for restricted visuals)">
                        <span class="preset-icon"><span class="material-icons-outlined">highlight</span></span> Force All to Highlight
                    </button>
                </div>
            </section>

            <!-- Visual Capabilities Legend -->
            <section id="interactions-capabilities-section" class="capabilities-section hidden">
                <details>
                    <summary style="cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">
                        Visual Interaction Capabilities
                    </summary>
                    <div class="capabilities-content" style="margin-top: 0.5rem;">
                        <table class="capabilities-table" style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background-color: #f5f5f5; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 0.5rem; text-align: left;">Visual Type</th>
                                    <th style="padding: 0.5rem; text-align: center;">Filter</th>
                                    <th style="padding: 0.5rem; text-align: center;">Highlight</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 0.5rem;">Most visuals</td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--success-color);font-size:18px">check_circle</span></td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--success-color);font-size:18px">check_circle</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee; background-color: #fff8e1;">
                                    <td style="padding: 0.5rem;"><strong>Slicer</strong></td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--success-color);font-size:18px">check_circle</span></td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--danger-color);font-size:18px">cancel</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee; background-color: #e3f2fd;">
                                    <td style="padding: 0.5rem;"><strong>Line/Scatter/Map</strong></td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--success-color);font-size:18px">check_circle</span></td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--danger-color);font-size:18px">cancel</span></td>
                                </tr>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 0.5rem;">Textbox/Image</td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--danger-color);font-size:18px">cancel</span></td>
                                    <td style="padding: 0.5rem; text-align: center;"><span class="material-icons-outlined" style="color:var(--danger-color);font-size:18px">cancel</span></td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="margin-top: 0.75rem; font-size: 0.8125rem; color: #666; line-height: 1.4;">
                            <strong>Note:</strong> When using bulk actions, the tool automatically applies fallback modes for restricted visuals.
                        </p>
                    </div>
                </details>
            </section>

            <!-- View Toggle -->
            <section id="interactions-view-section" class="view-toggle-section hidden">
                <div class="view-toggle">
                    <button id="interactions-view-matrix-btn" class="view-btn active" data-view="matrix"><span class="material-icons-outlined">grid_view</span> Matrix</button>
                    <button id="interactions-view-list-btn" class="view-btn" data-view="list"><span class="material-icons-outlined">view_list</span> List</button>
                    <span id="interactions-view-hint" class="view-hint"></span>
                </div>
            </section>

            <!-- Actions Section -->
            <section id="interactions-actions-section" class="actions-section hidden">
                <div class="actions-row">
                    <div class="selection-actions">
                        <button id="interactions-select-all-btn" class="btn btn-secondary">Select All</button>
                        <button id="interactions-select-none-btn" class="btn btn-secondary">Select None</button>
                    </div>
                    <div class="bulk-actions">
                        <button id="interactions-set-none-btn" class="btn btn-action interactions-bulk-btn" disabled title="Set selected to None (Ctrl+Click cells to select)">Set None</button>
                        <button id="interactions-set-filter-btn" class="btn btn-action interactions-bulk-btn" disabled title="Set selected to Filter">Set Filter</button>
                        <button id="interactions-set-highlight-btn" class="btn btn-action interactions-bulk-btn" disabled title="Set selected to Highlight">Set Highlight</button>
                        <button id="interactions-reset-btn" class="btn btn-action interactions-bulk-btn" disabled title="Reset selected to default">Reset</button>
                    </div>
                    <p class="action-hint" id="interactions-action-hint">Ctrl+Click cells to select, then use bulk actions</p>
                </div>
            </section>

            <!-- Matrix/List Container -->
            <section id="interactions-matrix-section" class="matrix-section hidden">
                <div id="interactions-matrix-container" class="interaction-matrix-container"></div>
                <div id="interactions-list-container" class="interaction-list-container hidden"></div>
            </section>

            <!-- Save Section -->
            <section id="interactions-save-section" class="save-section hidden">
                <div class="save-row">
                    <button id="interactions-save-btn" class="btn btn-primary" disabled>Save Changes</button>
                    <span id="interactions-modified-status" class="modified-status">No changes</span>
                </div>
            </section>

            <!-- History Section -->
            <section id="interactions-history-section" class="history-section hidden">
                <div class="history-row">
                    <button id="interactions-undo-btn" class="btn btn-secondary" disabled>Undo</button>
                    <button id="interactions-undo-all-btn" class="btn btn-secondary" disabled>Undo All</button>
                    <button id="interactions-export-csv-btn" class="btn btn-secondary">Export CSV</button>
                    <button id="interactions-export-json-btn" class="btn btn-secondary">Export JSON</button>
                    <span id="interactions-history-status" class="history-status">History: 0 changes</span>
                </div>
            </section>
        </div>

        <!-- Batch Processing Tab -->
        <div id="tab-batch-processing" class="tab-content hidden">
            <section id="batch-intro-section" class="batch-intro-section">
                <p class="batch-description">Process multiple PBIR report folders at once. Add reports to the queue, select settings, and apply changes to all reports.</p>
            </section>

            <section id="batch-queue-section" class="batch-queue-section">
                <div class="batch-queue-header">
                    <h3>Report Queue</h3>
                    <button id="batch-clear-queue-btn" class="btn btn-secondary btn-sm" disabled>Clear All</button>
                </div>
                <div id="batch-queue-list" class="batch-queue-list">
                    <div class="batch-queue-empty">No reports added. Click "Add Report" to start.</div>
                </div>
                <button id="batch-add-report-btn" class="btn btn-primary">+ Add Report Folder</button>
            </section>

            <section id="batch-settings-section" class="batch-settings-section">
                <h3>Batch Settings</h3>
                <div class="batch-settings-row">
                    <label for="batch-preset-select">Apply Preset:</label>
                    <select id="batch-preset-select">
                        <option value="">-- Select a preset --</option>
                        <optgroup label="Filter Visibility">
                            <option value="hide-all-filters">Hide All Filters</option>
                            <option value="show-all-filters">Show All Filters</option>
                            <option value="reset-all-filters">Reset All Filters</option>
                        </optgroup>
                        <optgroup label="Layer Order">
                            <option value="lock-all-layers">Lock All Layers</option>
                            <option value="unlock-all-layers">Unlock All Layers</option>
                            <option value="reset-all-layers">Reset All Layers</option>
                        </optgroup>
                        <optgroup label="Visual Interactions">
                            <option value="disable-all-interactions">Disable All Interactions</option>
                            <option value="enable-all-interactions">Enable All (Default)</option>
                            <option value="filter-all-interactions">Set All to Filter</option>
                            <option value="highlight-all-interactions">Set All to Highlight</option>
                        </optgroup>
                    </select>
                </div>
                <p id="batch-preset-description" class="preset-description hidden"></p>
                <div class="batch-manual-settings">
                    <p class="batch-manual-label">Or configure manually:</p>
                    <div class="batch-checkbox-row">
                        <input type="checkbox" id="batch-filter-enabled">
                        <label for="batch-filter-enabled">Set isHiddenInViewMode to:</label>
                        <select id="batch-filter-value" disabled>
                            <option value="true">Hidden (true)</option>
                            <option value="false">Visible (false)</option>
                            <option value="undefined">Remove property</option>
                        </select>
                    </div>
                    <div class="batch-checkbox-row">
                        <input type="checkbox" id="batch-layer-enabled">
                        <label for="batch-layer-enabled">Set keepLayerOrder to:</label>
                        <select id="batch-layer-value" disabled>
                            <option value="true">Enabled (true)</option>
                            <option value="false">Disabled (false)</option>
                            <option value="undefined">Remove property</option>
                        </select>
                    </div>
                    <div class="batch-checkbox-row">
                        <input type="checkbox" id="batch-interactions-enabled">
                        <label for="batch-interactions-enabled">Set visual interactions to:</label>
                        <select id="batch-interactions-value" disabled>
                            <option value="NoFilter">Disabled (None)</option>
                            <option value="DataFilter">Filter</option>
                            <option value="HighlightFilter">Highlight</option>
                            <option value="null">Reset to Default</option>
                        </select>
                    </div>
                </div>
            </section>

            <section id="batch-action-section" class="batch-action-section">
                <button id="batch-process-btn" class="btn btn-primary btn-large" disabled>Apply to All Reports</button>
                <span id="batch-status" class="batch-status"></span>
            </section>

            <section id="batch-progress-section" class="batch-progress-section hidden">
                <h3>Processing Progress</h3>
                <div class="batch-progress-bar">
                    <div id="batch-progress-fill" class="batch-progress-fill" style="width: 0%"></div>
                </div>
                <div id="batch-progress-text" class="batch-progress-text">0 / 0 reports processed</div>
                <div id="batch-results-list" class="batch-results-list"></div>
            </section>
        </div>

        <section id="empty-state" class="empty-state hidden">
            <h3>No visuals found</h3>
            <p>This usually means:</p>
            <ul>
                <li>You selected the wrong folder - try selecting the parent folder</li>
                <li>Your report has no filter or layer settings to manage</li>
                <li>The report is not in PBIR format (.pbip)</li>
            </ul>
            <p><strong>Tip:</strong> Look for a folder containing 'pages' or 'definition' subdirectories.</p>
        </section>
    </div>

    <!-- Sponsor Sidebar -->
    <aside class="sponsor-sidebar">
        <div class="sponsor-header">Sponsors</div>
        <div class="sponsor-placeholder">
            <div class="sponsor-empty">Your company here</div>
            <a href="https://www.linkedin.com/in/jihwankim1975/" target="_blank" class="btn btn-sponsor">Want to sponsor? Contact me</a>
        </div>
        <div class="sponsor-info">
            Interested in reaching Power BI professionals?
            <a href="https://www.linkedin.com/in/jihwankim1975/" target="_blank">Click here to contact.</a>
        </div>
    </aside>
    </div><!-- end main-layout -->

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-left">
            Built by <a href="https://www.linkedin.com/in/jihwankim1975/" target="_blank">Jihwan Kim</a>
            <span class="footer-separator">|</span>
            <span class="footer-title">Power BI Developer & Data Model Architect</span>
        </div>
        <div class="footer-center">
            <span>&copy; 2026</span>
            <span class="footer-separator">|</span>
            <a href="https://github.com/JonathanJihwanKim/isHiddenInViewMode/blob/main/LICENSE" target="_blank">MIT License</a>
            <span class="footer-separator">|</span>
            <a href="https://github.com/JonathanJihwanKim/isHiddenInViewMode" target="_blank">View on GitHub</a>
        </div>
        <div class="footer-right">
            <a href="https://www.linkedin.com/in/jihwankim1975/" target="_blank" class="linkedin-link">
                <svg class="linkedin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
                Connect
            </a>
        </div>
    </footer>

    <div id="toast" class="toast hidden"></div>

    <!-- Save Preset Modal -->
    <div id="save-preset-modal" class="modal hidden">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>Save Preset</h2>
                <button id="close-preset-modal-btn" class="close-btn"><span class="material-icons-outlined">close</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="preset-name-input">Preset Name:</label>
                    <input type="text" id="preset-name-input" placeholder="Enter preset name" maxlength="30">
                </div>
                <div id="preset-config-summary" class="preset-config-summary"></div>
            </div>
            <div class="modal-footer">
                <button id="cancel-preset-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-save-preset-btn" class="btn btn-primary">Save Preset</button>
            </div>
        </div>
    </div>

    <!-- Documentation Modal -->
    <div id="doc-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Documentation</h2>
                <button id="close-modal-btn" class="close-btn"><span class="material-icons-outlined">close</span></button>
            </div>
            <div class="modal-body">
                <h3>What is PBIR Visual Manager?</h3>
                <p>This tool helps you manage visual properties in Power BI PBIR reports. It provides three main features:</p>
                <ul>
                    <li><strong>Filter Visibility</strong> - Control whether filters are hidden or visible in reading mode</li>
                    <li><strong>Layer Order</strong> - Control whether visuals maintain their z-order during interactions</li>
                    <li><strong>Visual Interactions</strong> - Control how visuals interact with each other (filter, highlight, or none)</li>
                </ul>

                <h3>Filter Visibility (isHiddenInViewMode)</h3>
                <p>The <code>isHiddenInViewMode</code> property determines if a filter pane is visible to report viewers. When set to <code>true</code>, the filter is hidden from users but still applies to the data.</p>
                <h4>Quick Actions</h4>
                <ul>
                    <li><strong>Hide All</strong> - Sets all filters to hidden (isHiddenInViewMode = true). Filters will still apply to data but won't be visible to report viewers.</li>
                    <li><strong>Show All</strong> - Sets all filters to visible (isHiddenInViewMode = false). Report viewers can see and interact with all filters.</li>
                    <li><strong>Reset All</strong> - Removes the isHiddenInViewMode property from all filters, restoring Power BI's default behavior.</li>
                    <li><strong>Save Preset</strong> - Saves your current filter visibility configuration as a reusable preset stored in your browser.</li>
                </ul>

                <h3>Layer Order (keepLayerOrder)</h3>
                <p>The <code>keepLayerOrder</code> property controls whether visuals maintain their defined z-order (stacking order) during user interactions. This is critical for reports with overlapping elements or layered designs.</p>
                <ul>
                    <li><strong>Enabled (true)</strong> - Visual maintains its layer position</li>
                    <li><strong>Disabled (false)</strong> - Visual may move to front on interaction</li>
                    <li><strong>Not Set</strong> - Uses Power BI default behavior</li>
                </ul>
                <h4>Quick Actions</h4>
                <ul>
                    <li><strong>Lock All</strong> - Sets keepLayerOrder = true for all visuals. Visuals maintain their defined z-order during user interactions.</li>
                    <li><strong>Unlock All</strong> - Sets keepLayerOrder = false for all visuals. Visuals may move to the front when clicked or interacted with.</li>
                    <li><strong>Reset All</strong> - Removes the keepLayerOrder property from all visuals, restoring Power BI's default behavior.</li>
                    <li><strong>Save Preset</strong> - Saves your current layer order configuration as a reusable preset stored in your browser.</li>
                </ul>

                <h3>Visual Interactions</h3>
                <p>The Visual Interactions feature allows you to control how selecting data in one visual affects other visuals on the same page. This is the <code>visualInteractions</code> property stored in <code>page.json</code>.</p>
                <h4>Interaction Types</h4>
                <ul>
                    <li><strong>Default</strong> - Power BI determines the behavior (no explicit setting)</li>
                    <li><strong>Filter (DataFilter)</strong> - Selection in source visual filters the target visual</li>
                    <li><strong>Highlight (HighlightFilter)</strong> - Selection in source visual highlights data in target visual</li>
                    <li><strong>None (NoFilter)</strong> - Selection in source visual is ignored by target visual</li>
                </ul>
                <h4>Using the Matrix View</h4>
                <ul>
                    <li>Row headers are <strong>source visuals</strong> (where you click)</li>
                    <li>Column headers are <strong>target visuals</strong> (what gets affected)</li>
                    <li>Click a cell to change the interaction type</li>
                    <li>Ctrl+Click cells to select multiple, then use bulk actions</li>
                    <li>For pages with 20+ visuals, List View is recommended for performance</li>
                </ul>
                <h4>Quick Actions</h4>
                <ul>
                    <li><strong>Disable All</strong> - Sets all interactions to None (NoFilter). No cross-filtering or highlighting.</li>
                    <li><strong>Reset to Defaults</strong> - Removes explicit interaction overrides, letting Power BI use report-level default behavior.</li>
                    <li><strong>Force All to Filter</strong> - Sets all interactions to Filter (DataFilter), with smart fallbacks for visuals that don't support highlighting.</li>
                    <li><strong>Force All to Highlight</strong> - Sets all interactions to Highlight (HighlightFilter), with smart fallbacks for visuals that don't support highlighting.</li>
                </ul>
                <h4>Visual Interaction Capabilities</h4>
                <p>Not all Power BI visuals support both cross-filtering and cross-highlighting:</p>
                <ul>
                    <li><strong>Slicers</strong> - Can only filter other visuals, cannot highlight</li>
                    <li><strong>Line charts, Scatter charts, Maps</strong> - Can only be cross-filtered, not cross-highlighted</li>
                    <li><strong>Most other visuals</strong> (Column/Bar charts, Tables, Matrix, etc.) - Support both filtering and highlighting</li>
                </ul>
                <p>When you use "Force All to Highlight", the tool automatically uses Filter mode for visuals that don't support highlighting.</p>

                <h3>Batch Processing</h3>
                <p>Process multiple PBIR reports at once with consistent settings:</p>
                <ol>
                    <li><strong>Add Reports</strong> - Click "Add Report Folder" to add PBIR reports to the queue. Each report shows its visual count.</li>
                    <li><strong>Choose Settings</strong> - Select a preset (e.g., Hide All Filters, Lock All Layers) or configure manual settings.</li>
                    <li><strong>Process All</strong> - Click "Apply to All Reports" to process the entire queue. Progress and results are shown in real-time.</li>
                </ol>
                <p><strong>Use Cases:</strong></p>
                <ul>
                    <li>Standardize filter visibility across multiple reports</li>
                    <li>Apply consistent layer order settings to a report portfolio</li>
                    <li>Quickly prepare multiple reports for deployment</li>
                </ul>

                <h3>Requirements</h3>
                <div class="requirement-box">
                    <strong>Important:</strong> Your Power BI report MUST be saved in <strong>PBIR format</strong> (Power BI Enhanced Report Format) to use this tool.
                </div>
                <p>To enable PBIR format:</p>
                <ol>
                    <li>Open Power BI Desktop</li>
                    <li>Go to <strong>File &gt; Options and settings &gt; Options</strong></li>
                    <li>Select <strong>Preview features</strong></li>
                    <li>Enable <strong>Power BI Project (.pbip) save option</strong></li>
                    <li>Save your report as a <strong>.pbip</strong> file</li>
                </ol>
                <p><strong>Browser requirement:</strong> Chrome, Edge, or Opera (requires File System Access API)</p>

                <h3>How to Use</h3>
                <div class="step-item">
                    <span class="step-number">1</span>
                    <div class="step-content">
                        <strong>Select Folder</strong><br>
                        Click the "Select Folder" button and navigate to your PBIR report folder. Select the folder containing <code>pages</code> or <code>definition</code> directories.
                    </div>
                </div>
                <div class="step-item">
                    <span class="step-number">2</span>
                    <div class="step-content">
                        <strong>Choose Tab</strong><br>
                        Select either "Filter Visibility" or "Layer Order" tab depending on which property you want to manage.
                    </div>
                </div>
                <div class="step-item">
                    <span class="step-number">3</span>
                    <div class="step-content">
                        <strong>Review &amp; Select Visuals</strong><br>
                        Use checkboxes to select the visuals you want to modify. Use "Select All" or "Select None" for bulk selection.
                    </div>
                </div>
                <div class="step-item">
                    <span class="step-number">4</span>
                    <div class="step-content">
                        <strong>Apply Changes</strong><br>
                        Click the action buttons to set properties. For Filter Visibility, expand rows to modify individual filters.
                    </div>
                </div>
                <div class="step-item">
                    <span class="step-number">5</span>
                    <div class="step-content">
                        <strong>Save Changes</strong><br>
                        Click "Save Changes" to write your modifications back to the visual.json files. Changes are permanent once saved.
                    </div>
                </div>

                <h3>Understanding Status</h3>
                <h4>Filter Visibility Status</h4>
                <div class="status-legend">
                    <div class="status-legend-item">
                        <span class="status-badge status-hidden">Hidden</span>
                        <span>isHiddenInViewMode = true</span>
                    </div>
                    <div class="status-legend-item">
                        <span class="status-badge status-visible">Visible</span>
                        <span>isHiddenInViewMode = false</span>
                    </div>
                    <div class="status-legend-item">
                        <span class="status-badge status-default">Default</span>
                        <span>Property not set</span>
                    </div>
                    <div class="status-legend-item">
                        <span class="status-badge status-mixed">Mixed</span>
                        <span>Filters have different settings</span>
                    </div>
                    <div class="status-legend-item">
                        <span class="status-badge status-no-filters">No Filters</span>
                        <span>Visual has no filters</span>
                    </div>
                </div>

                <h4>Layer Order Status</h4>
                <div class="status-legend">
                    <div class="status-legend-item">
                        <span class="status-badge status-visible">Enabled</span>
                        <span>keepLayerOrder = true</span>
                    </div>
                    <div class="status-legend-item">
                        <span class="status-badge status-hidden">Disabled</span>
                        <span>keepLayerOrder = false</span>
                    </div>
                    <div class="status-legend-item">
                        <span class="status-badge status-default">Not Set</span>
                        <span>Property not set</span>
                    </div>
                </div>

                <h3>Tips</h3>
                <div class="tip-box">
                    <ul>
                        <li><strong>Undo changes:</strong> Use "Undo" or "Undo All" to revert changes before saving</li>
                        <li><strong>Export reports:</strong> Use "Export CSV" or "Export JSON" to document your settings</li>
                        <li><strong>Filter by status:</strong> Use the dropdown to show only visuals with specific status</li>
                        <li><strong>Individual filter control:</strong> In Filter Visibility tab, expand a visual row to modify individual filters</li>
                        <li><strong>Independent tabs:</strong> Changes in one tab don't affect the other - you can work on both and save together</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
